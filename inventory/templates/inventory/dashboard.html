{% extends 'inventory/base.html' %}

{% block content %}
<div class="dashboard-grid">
    <!-- Stats Row -->
    <div class="stats-row">
        <div class="stat-card">
            <h3>Total Items</h3>
            <div class="value">{{ total_count }}</div>
            <div class="trend positive">All Categories</div>
        </div>
        <div class="stat-card warning">
            <h3>Low Stock</h3>
            <div class="value">{{ low_stock_count }}</div>
            <div class="trend negative">Action Needed</div>
        </div>
        <div class="stat-card">
            <h3>Total Value</h3>
            <div class="value">${{ total_value }}</div>
            <div class="trend">Estimated</div>
        </div>
    </div>

    <!-- Main Inventory Table -->
    <div class="panel">
        <div class="panel-header">
            <h2>Current Inventory</h2>
            <div class="filters">
                <span class="filter active">All</span>
                <span class="filter">Cleaning</span>
                <span class="filter">Food</span>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Category</th>
                        <th>In Stock</th>
                        <th>Status</th>
                        <th>Unit Cost</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td class="fw-600">{{ item.item_name }}</td>
                        <td>{{ item.category.category_name }}</td>
                        <td>
                            {{ item.quantity_in_stock|floatformat:0 }}
                            {% if item.quantity_in_stock < item.minimum_quantity %} <span class="badge badge-low">
                                Low</span>
                                {% endif %}
                        </td>
                        <td>
                            <div class="progress-bar">
                                <div class="fill" style="width: {% widthratio item.quantity_in_stock 500 100 %}%;">
                                </div>
                            </div>
                        </td>
                        <td>${{ item.unit_cost }}</td>
                        <td>
                            <button class="btn-sm">Edit</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="panel">
        <div class="panel-header">
            <h2>Recent Transactions</h2>
            <button class="btn-sm" onclick="openModal('requestModal')">Request Supply</button>
        </div>
        <ul class="transaction-list">
            {% for trans in transactions %}
            <li class="trans-item">
                <div class="trans-icon {{ trans.transaction_type }}">{{ trans.transaction_type|first|upper }}</div>
                <div class="trans-details">
                    <span class="trans-title">{{ trans.item.item_name }}</span>
                    <span class="trans-meta">{{ trans.department|default:"System" }} â€¢ {{
                        trans.transaction_date|date:"H:i" }}</span>
                </div>
                <div class="trans-amount {% if trans.quantity < 0 %}negative{% else %}positive{% endif %}">
                    {{ trans.quantity|floatformat:0 }}
                </div>
            </li>
            {% empty %}
            <li class="trans-item">No recent transactions</li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- Restock Modal -->
<div id="restockModal" class="modal">
    <div class="modal-content">
        <h3>Restock Item</h3>
        <form action="{% url 'restock' %}" method="POST">
            {% csrf_token %}
            <div class="form-group">
                <label>Item Name</label>
                <select name="item_name" required class="form-control">
                    {% for item in items %}
                    <option value="{{ item.item_name }}">{{ item.item_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Quantity to Add</label>
                <input type="number" name="quantity" min="1" required class="form-control">
            </div>
            <div class="form-actions">
                <button type="button" onclick="closeModal('restockModal')" class="btn-cancel">Cancel</button>
                <button type="submit" class="btn-primary">Confirm Restock</button>
            </div>
        </form>
    </div>
</div>

<!-- Request Supply Modal -->
<div id="requestModal" class="modal">
    <div class="modal-content">
        <h3>Request Supplies</h3>
        <form action="{% url 'request_supply' %}" method="POST">
            {% csrf_token %}
            <div class="form-group">
                <label>Staff Name</label>
                <input type="text" name="staff_name" placeholder="e.g. Maria" required class="form-control">
            </div>
            <div class="form-group">
                <label>Item Name</label>
                <select name="item_name" required class="form-control">
                    {% for item in items %}
                    <option value="{{ item.item_name }}">{{ item.item_name }} ({{ item.quantity_in_stock|floatformat:0
                        }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Quantity Needed</label>
                <input type="number" name="quantity" min="1" required class="form-control">
            </div>
            <div class="form-actions">
                <button type="button" onclick="closeModal('requestModal')" class="btn-cancel">Cancel</button>
                <button type="submit" class="btn-primary">Submit Request</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openModal(id) {
        document.getElementById(id).style.display = 'flex';
    }
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }
</script>
{% endblock %}